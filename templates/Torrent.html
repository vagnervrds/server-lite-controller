<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Gerenciador de Downloads</title>
    <style>

    </style>
</head>

<body>
    <div class="container">
        <h1>Gerenciador de Downloads</h1>

        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %} {% endif %} {% endwith %}

        <form method="POST">
            <div class="form-group">
                <label for="magnet_link">Adicionar Magnet Link:</label>
                <input type="text" id="magnet_link" name="magnet_link" placeholder="Cole o magnet link aqui" required />
            </div>
            <button type="submit">Adicionar Download</button>
        </form>

        <div class="downloads">
            <h2>Downloads Ativos</h2>
            <div id="downloads-container">
                <p>Carregando downloads...</p>
            </div>
        </div>

        <script>
            let isListingFiles = false;

            document.addEventListener("DOMContentLoaded", () => {
                const downloadsContainer = document.getElementById("downloads-container");

                // Função para atualizar a lista de downloads
                function fetchDownloads() {
                    if (isListingFiles) return; // Pausa o fetch se estiver listando arquivos
                    fetch("/torrent/downloads")
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.downloads && data.downloads.length > 0) {
                                downloadsContainer.innerHTML = ""; // Limpa o contêiner
                                data.downloads.forEach((download) => {
                                    const downloadItem = document.createElement("div");
                                    downloadItem.className = "download-item";
                                    downloadItem.setAttribute("data-id", download.id);

                                    downloadItem.innerHTML = `
                      <div>${download.name}</div>
                      <div class="progress-bar">
                          <div class="progress-fill" style="width: ${download.progress}%"></div>
                      </div>
                      <div>Status: ${download.state} - ${download.progress}%</div>
                      <div class="actions">
                          <button class="btn-stop" data-id="${download.id}">Parar</button>
                          <button class="btn-cancel" data-id="${download.id}">Cancelar</button>
                          <button class="btn-delete" data-id="${download.id}">Apagar</button>
                          <button class="btn-list-files" data-id="${download.id}">Listar Arquivos</button>
                      </div>
                    `;

                                    downloadsContainer.appendChild(downloadItem);

                                    // Adiciona eventos aos botões
                                    addActionListeners(downloadItem);
                                });
                            } else {
                                downloadsContainer.innerHTML = "<p>Nenhum download ativo no momento.</p>";
                            }
                        })
                        .catch((err) => {
                            downloadsContainer.innerHTML = `<p>Erro ao carregar downloads: ${err.message}</p>`;
                            console.error(err);
                        });
                }

                // Função para listar arquivos
                function listFiles(torrentId, container) {
                    isListingFiles = true; // Pausa atualizações automáticas
                    fetch(`/torrent/list-files/${torrentId}`, { method: "GET" })
                        .then((response) => response.json())
                        .then((data) => {
                            const fileTable = `
                  <table class="file-table">
                      <thead>
                          <tr>
                              <th>Baixar</th>
                              <th>Nome</th>
                              <th>Tamanho</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${data.files
                                    .map(
                                        (file) => `
                              <tr>
                                  <td><input type="checkbox" checked></td>
                                  <td>${file.name}</td>
                                  <td>${file.size}</td>
                              </tr>
                          `
                                    )
                                    .join("")}
                      </tbody>
                  </table>
                `;
                            container.innerHTML =
                                fileTable + '<button class="btn-close-files">Fechar</button>';

                            // Adiciona evento para fechar a tabela
                            container
                                .querySelector(".btn-close-files")
                                .addEventListener("click", () => {
                                    isListingFiles = false; // Retoma atualizações automáticas
                                    container.innerHTML = ""; // Limpa a tabela
                                    fetchDownloads(); // Atualiza os downloads
                                });
                        })
                        .catch((err) => console.error(err));
                }

                // Adiciona listeners aos botões de ação
                function addActionListeners(downloadItem) {
                    const torrentId = downloadItem.dataset.id;

                    // Botão Parar
                    downloadItem
                        .querySelector(".btn-stop")
                        .addEventListener("click", () => {
                            fetch(`/torrent/stop/${torrentId}`, { method: "POST" })
                                .then((response) => response.json())
                                .then((data) => alert(data.message))
                                .catch((err) => console.error(err));
                        });

                    // Botão Cancelar
                    downloadItem
                        .querySelector(".btn-cancel")
                        .addEventListener("click", () => {
                            fetch(`/torrent/cancel/${torrentId}`, { method: "POST" })
                                .then((response) => response.json())
                                .then((data) => alert(data.message))
                                .catch((err) => console.error(err));
                        });

                    // Botão Apagar
                    downloadItem
                        .querySelector(".btn-delete")
                        .addEventListener("click", () => {
                            fetch(`/torrent/delete/${torrentId}`, { method: "POST" })
                                .then((response) => response.json())
                                .then((data) => alert(data.message))
                                .catch((err) => console.error(err));
                        });

                    // Botão Listar Arquivos
                    downloadItem
                        .querySelector(".btn-list-files")
                        .addEventListener("click", () => {
                            const container = downloadItem.querySelector(".actions");
                            listFiles(torrentId, container);
                        });
                }

                // Atualiza a lista de downloads a cada 5 segundos
                setInterval(fetchDownloads, 5000);

                // Carrega os downloads inicialmente
                fetchDownloads();
            });
        </script>
    </div>
</body>

</html>